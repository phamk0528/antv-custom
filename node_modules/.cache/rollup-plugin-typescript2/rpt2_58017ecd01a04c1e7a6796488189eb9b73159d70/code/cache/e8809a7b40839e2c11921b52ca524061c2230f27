{"code":"import { __assign, __extends } from \"tslib\";\r\nimport { difference } from 'lodash';\r\nimport { hideColumnsByThunkGroup, isEqualDisplaySiblingNodeId, } from \"../../../utils/hide-columns\";\r\nimport { BaseEvent } from \"../../base-event\";\r\nimport { S2Event, InteractionKeyboardKey, InterceptType, CellTypes, TOOLTIP_OPERATOR_HIDDEN_COLUMNS_MENU, } from \"../../../common/constant\";\r\nimport { mergeCellInfo, getTooltipOptions, getTooltipVisibleOperator, } from \"../../../utils/tooltip\";\r\nvar RowColumnClick = /** @class */ (function (_super) {\r\n    __extends(RowColumnClick, _super);\r\n    function RowColumnClick() {\r\n        var _this = _super !== null && _super.apply(this, arguments) || this;\r\n        _this.isMultiSelection = false;\r\n        _this.handleRowColClick = function (event, isTreeRowClick) {\r\n            if (isTreeRowClick === void 0) { isTreeRowClick = false; }\r\n            event.stopPropagation();\r\n            var interaction = _this.spreadsheet.interaction;\r\n            var cell = _this.spreadsheet.getCell(event.target);\r\n            if (interaction.isSelectedCell(cell)) {\r\n                interaction.reset();\r\n                return;\r\n            }\r\n            if (interaction.selectHeaderCell({\r\n                cell: cell,\r\n                isTreeRowClick: isTreeRowClick,\r\n                isMultiSelection: _this.isMultiSelection,\r\n            })) {\r\n                _this.showTooltip(event);\r\n            }\r\n        };\r\n        _this.getHideColumnField = function (node) {\r\n            return _this.spreadsheet.isTableMode() ? node.field : node.id;\r\n        };\r\n        return _this;\r\n    }\r\n    RowColumnClick.prototype.bindEvents = function () {\r\n        this.bindKeyboardDown();\r\n        this.bindKeyboardUp();\r\n        this.bindColCellClick();\r\n        this.bindRowCellClick();\r\n        this.bindTableColExpand();\r\n    };\r\n    RowColumnClick.prototype.bindKeyboardDown = function () {\r\n        var _this = this;\r\n        this.spreadsheet.on(S2Event.GLOBAL_KEYBOARD_DOWN, function (event) {\r\n            if (event.key === InteractionKeyboardKey.META) {\r\n                _this.isMultiSelection = true;\r\n            }\r\n        });\r\n    };\r\n    RowColumnClick.prototype.bindKeyboardUp = function () {\r\n        var _this = this;\r\n        this.spreadsheet.on(S2Event.GLOBAL_KEYBOARD_UP, function (event) {\r\n            if (event.key === InteractionKeyboardKey.META) {\r\n                _this.isMultiSelection = false;\r\n                _this.spreadsheet.interaction.removeIntercepts([InterceptType.CLICK]);\r\n            }\r\n        });\r\n    };\r\n    RowColumnClick.prototype.bindRowCellClick = function () {\r\n        var _this = this;\r\n        this.spreadsheet.on(S2Event.ROW_CELL_CLICK, function (event) {\r\n            _this.handleRowColClick(event, _this.spreadsheet.isHierarchyTreeType());\r\n        });\r\n    };\r\n    RowColumnClick.prototype.bindColCellClick = function () {\r\n        var _this = this;\r\n        this.spreadsheet.on(S2Event.COL_CELL_CLICK, function (event) {\r\n            _this.handleRowColClick(event);\r\n        });\r\n    };\r\n    RowColumnClick.prototype.showTooltip = function (event) {\r\n        var _a = getTooltipOptions(this.spreadsheet, event), operation = _a.operation, showTooltip = _a.showTooltip;\r\n        if (!showTooltip) {\r\n            return;\r\n        }\r\n        var interaction = this.spreadsheet.interaction;\r\n        var cellInfos = interaction.isSelectedState()\r\n            ? mergeCellInfo(interaction.getActiveCells())\r\n            : [];\r\n        var operator = this.getTooltipOperator(event, operation);\r\n        this.spreadsheet.showTooltipWithInfo(event, cellInfos, {\r\n            showSingleTips: true,\r\n            operator: operator,\r\n        });\r\n    };\r\n    RowColumnClick.prototype.getTooltipOperator = function (event, operation) {\r\n        var _this = this;\r\n        var cell = this.spreadsheet.getCell(event.target);\r\n        var cellMeta = cell.getMeta();\r\n        var isColCell = cell.cellType === CellTypes.COL_CELL;\r\n        // 只有一个叶子节点时, 不显示隐藏按钮\r\n        var isOnlyOneLeafColumn = this.spreadsheet.getColumnLeafNodes().length === 1;\r\n        var enableHiddenColumnOperator = isColCell &&\r\n            !isOnlyOneLeafColumn &&\r\n            cellMeta.isLeaf &&\r\n            operation.hiddenColumns;\r\n        var hiddenColumnsMenu = enableHiddenColumnOperator && __assign(__assign({}, TOOLTIP_OPERATOR_HIDDEN_COLUMNS_MENU), { onClick: function () {\r\n                _this.hideSelectedColumns();\r\n            } });\r\n        return getTooltipVisibleOperator(operation, {\r\n            defaultMenus: [hiddenColumnsMenu],\r\n            cell: cell,\r\n        });\r\n    };\r\n    RowColumnClick.prototype.bindTableColExpand = function () {\r\n        var _this = this;\r\n        this.spreadsheet.on(S2Event.LAYOUT_COLS_EXPANDED, function (node) {\r\n            _this.handleExpandIconClick(node);\r\n        });\r\n    };\r\n    /**\r\n     * 隐藏选中的列\r\n     * 每次点击存储两个信息\r\n     * 1. [hiddenColumnFields]: 当前选中 (单/多选) 的 field, 对应 dataCfg 里面的 column\r\n     *    用于点击展开按钮后还原, 区别于 options.hiddenColumnFields, 这里需要分段存储, 比如现在有两个隐藏的列\r\n     *    [1,2, (3隐藏), 4, 5, (6隐藏), 7]\r\n     *    展开按钮在 4, 7, 点击任意按钮, 应该只展开所对应的那组 : 4 => [3], 7 => [6]\r\n     * 2. [displaySiblingNode]: 当前这一组的列隐藏后, 需要将展开按钮显示到对应的兄弟节点\r\n     * 这样不用每次 render 的时候实时计算, 渲染列头单元格 直接取数据即可\r\n     */\r\n    RowColumnClick.prototype.hideSelectedColumns = function () {\r\n        var interaction = this.spreadsheet.interaction;\r\n        var selectedColumnNodes = interaction\r\n            .getActiveCells()\r\n            .map(function (cell) { return cell.getMeta(); });\r\n        var selectedColumnFields = selectedColumnNodes.map(this.getHideColumnField);\r\n        // 兼容多选\r\n        hideColumnsByThunkGroup(this.spreadsheet, selectedColumnFields, true);\r\n    };\r\n    RowColumnClick.prototype.handleExpandIconClick = function (node) {\r\n        var lastHiddenColumnsDetail = this.spreadsheet.store.get('hiddenColumnsDetail', []);\r\n        var _a = (lastHiddenColumnsDetail.find(function (_a) {\r\n            var displaySiblingNode = _a.displaySiblingNode;\r\n            return isEqualDisplaySiblingNodeId(displaySiblingNode, node.id);\r\n        }) || {}).hideColumnNodes, hideColumnNodes = _a === void 0 ? [] : _a;\r\n        var lastHideColumnFields = this.spreadsheet.options.interaction.hiddenColumnFields;\r\n        var willDisplayColumnFields = hideColumnNodes.map(this.getHideColumnField);\r\n        var hiddenColumnFields = difference(lastHideColumnFields, willDisplayColumnFields);\r\n        var hiddenColumnsDetail = lastHiddenColumnsDetail.filter(function (_a) {\r\n            var displaySiblingNode = _a.displaySiblingNode;\r\n            return !isEqualDisplaySiblingNodeId(displaySiblingNode, node.id);\r\n        });\r\n        this.spreadsheet.setOptions({\r\n            interaction: {\r\n                hiddenColumnFields: hiddenColumnFields,\r\n            },\r\n        });\r\n        this.spreadsheet.store.set('hiddenColumnsDetail', hiddenColumnsDetail);\r\n        this.spreadsheet.interaction.reset();\r\n        this.spreadsheet.render(false);\r\n    };\r\n    return RowColumnClick;\r\n}(BaseEvent));\r\nexport { RowColumnClick };\r\n//# sourceMappingURL=row-column-click.js.map","references":["F:/Ismart/S2-master/node_modules/@antv/g-canvas/lib/index.d.ts","F:/Ismart/S2-master/node_modules/@types/lodash/index.d.ts","F:/Ismart/S2-master/packages/s2-core/src/utils/hide-columns.ts","F:/Ismart/S2-master/packages/s2-core/src/interaction/base-event.ts","F:/Ismart/S2-master/packages/s2-core/src/common/constant/index.ts","F:/Ismart/S2-master/packages/s2-core/src/common/interface/index.ts","F:/Ismart/S2-master/packages/s2-core/src/facet/layout/node.ts","F:/Ismart/S2-master/packages/s2-core/src/utils/tooltip.ts"],"map":"{\"version\":3,\"file\":\"row-column-click.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../../src/interaction/base-interaction/click/row-column-click.ts\"],\"names\":[],\"mappings\":\"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\"}"}
