{"code":"import { __assign, __extends, __read, __spreadArray } from \"tslib\";\r\nimport { clone, last } from 'lodash';\r\nimport { SpreadSheet } from './spread-sheet';\r\nimport { DataCell } from \"../cell\";\r\nimport { EXTRA_FIELD, InterceptType, S2Event, TOOLTIP_OPERATOR_SORT_MENUS, } from \"../common/constant\";\r\nimport { PivotDataSet } from \"../data-set\";\r\nimport { CustomTreePivotDataSet } from \"../data-set/custom-tree-pivot-data-set\";\r\nimport { PivotFacet } from \"../facet\";\r\nvar PivotSheet = /** @class */ (function (_super) {\r\n    __extends(PivotSheet, _super);\r\n    function PivotSheet() {\r\n        return _super !== null && _super.apply(this, arguments) || this;\r\n    }\r\n    PivotSheet.prototype.getDataSet = function (options) {\r\n        var dataSet = options.dataSet, hierarchyType = options.hierarchyType;\r\n        if (dataSet) {\r\n            return dataSet(this);\r\n        }\r\n        var realDataSet = hierarchyType === 'customTree'\r\n            ? new CustomTreePivotDataSet(this)\r\n            : new PivotDataSet(this);\r\n        return realDataSet;\r\n    };\r\n    /**\r\n     * Check if is pivot mode\r\n     */\r\n    PivotSheet.prototype.isPivotMode = function () {\r\n        return true;\r\n    };\r\n    /**\r\n     * Check if is pivot mode\r\n     */\r\n    PivotSheet.prototype.isTableMode = function () {\r\n        return false;\r\n    };\r\n    /**\r\n     * tree type must be in strategy mode\r\n     */\r\n    PivotSheet.prototype.isHierarchyTreeType = function () {\r\n        var type = this.options.hierarchyType;\r\n        // custom tree and tree!!!\r\n        return type === 'tree' || type === 'customTree';\r\n    };\r\n    /**\r\n     * Check whether scroll contains row header\r\n     * For now contains row header in ListSheet mode by default\r\n     */\r\n    PivotSheet.prototype.isScrollContainsRowHeader = function () {\r\n        return !this.isFrozenRowHeader();\r\n    };\r\n    /**\r\n     * Scroll Freeze Row Header\r\n     */\r\n    PivotSheet.prototype.isFrozenRowHeader = function () {\r\n        var _a;\r\n        return (_a = this.options) === null || _a === void 0 ? void 0 : _a.frozenRowHeader;\r\n    };\r\n    /**\r\n     * Check if the value is in the columns\r\n     */\r\n    PivotSheet.prototype.isValueInCols = function () {\r\n        return this.dataSet.fields.valueInCols;\r\n    };\r\n    PivotSheet.prototype.clearDrillDownData = function (rowNodeId, preventRender) {\r\n        if (this.dataSet instanceof PivotDataSet) {\r\n            this.dataSet.clearDrillDownData(rowNodeId);\r\n            if (!preventRender) {\r\n                // 重置当前交互\r\n                this.interaction.reset();\r\n                this.render(false);\r\n            }\r\n        }\r\n    };\r\n    PivotSheet.prototype.getFacetCfgFromDataSetAndOptions = function () {\r\n        var _this = this;\r\n        var _a = this.dataSet, fields = _a.fields, meta = _a.meta;\r\n        var _b = this.options, style = _b.style, dataCell = _b.dataCell;\r\n        // 默认单元格实现\r\n        var defaultCell = function (facet) { return new DataCell(facet, _this); };\r\n        return __assign(__assign(__assign(__assign({}, fields), style), this.options), { meta: meta, spreadsheet: this, dataSet: this.dataSet, dataCell: dataCell !== null && dataCell !== void 0 ? dataCell : defaultCell });\r\n    };\r\n    PivotSheet.prototype.buildFacet = function () {\r\n        var _a;\r\n        var facetCfg = this.getFacetCfgFromDataSetAndOptions();\r\n        (_a = this.facet) === null || _a === void 0 ? void 0 : _a.destroy();\r\n        this.facet = new PivotFacet(facetCfg);\r\n        this.facet.render();\r\n    };\r\n    PivotSheet.prototype.bindEvents = function () {\r\n        this.off(S2Event.ROW_CELL_COLLAPSE_TREE_ROWS);\r\n        this.off(S2Event.LAYOUT_TREE_ROWS_COLLAPSE_ALL);\r\n        this.on(S2Event.ROW_CELL_COLLAPSE_TREE_ROWS, this.handleRowCellCollapseTreeRows);\r\n        // 收起、展开按钮\r\n        this.on(S2Event.LAYOUT_TREE_ROWS_COLLAPSE_ALL, this.handleTreeRowsCollapseAll);\r\n    };\r\n    PivotSheet.prototype.handleRowCellCollapseTreeRows = function (data) {\r\n        var _a;\r\n        var id = data.id, isCollapsed = data.isCollapsed;\r\n        var options = {\r\n            style: {\r\n                collapsedRows: (_a = {},\r\n                    _a[id] = isCollapsed,\r\n                    _a),\r\n            },\r\n        };\r\n        this.emit(S2Event.LAYOUT_COLLAPSE_ROWS, {\r\n            collapsedRows: options.style.collapsedRows,\r\n            meta: data === null || data === void 0 ? void 0 : data.node,\r\n        });\r\n        this.setOptions(options);\r\n        this.render(false);\r\n        this.emit(S2Event.LAYOUT_AFTER_COLLAPSE_ROWS, {\r\n            collapsedRows: options.style.collapsedRows,\r\n            meta: data === null || data === void 0 ? void 0 : data.node,\r\n        });\r\n    };\r\n    PivotSheet.prototype.handleTreeRowsCollapseAll = function (isCollapsed) {\r\n        var options = {\r\n            hierarchyCollapse: !isCollapsed,\r\n            style: {\r\n                collapsedRows: null,\r\n            },\r\n        };\r\n        this.setOptions(options);\r\n        this.render(false);\r\n    };\r\n    PivotSheet.prototype.groupSortByMethod = function (sortMethod, meta) {\r\n        var _a = this.dataCfg.fields, rows = _a.rows, columns = _a.columns;\r\n        var ifHideMeasureColumn = this.options.style.colCfg.hideMeasureColumn;\r\n        var sortFieldId = this.isValueInCols() ? last(rows) : last(columns);\r\n        var query = meta.query, value = meta.value;\r\n        var sortQuery = clone(query);\r\n        var sortValue = value;\r\n        // 数值置于列头且隐藏了指标列头的情况, 会默认取第一个指标做组内排序, 需要还原指标列的query, 所以多指标时请不要这么用……\r\n        if (ifHideMeasureColumn && this.isValueInCols()) {\r\n            sortValue = this.dataSet.fields.values[0];\r\n            sortQuery[EXTRA_FIELD] = sortValue;\r\n        }\r\n        var sortParam = {\r\n            sortFieldId: sortFieldId,\r\n            sortMethod: sortMethod,\r\n            sortByMeasure: sortValue,\r\n            query: sortQuery,\r\n        };\r\n        var prevSortParams = this.dataCfg.sortParams.filter(function (item) { return (item === null || item === void 0 ? void 0 : item.sortFieldId) !== sortFieldId; });\r\n        // 触发排序事件\r\n        this.emit(S2Event.RANGE_SORT, __spreadArray(__spreadArray([], __read(prevSortParams), false), [sortParam], false));\r\n        this.setDataCfg(__assign(__assign({}, this.dataCfg), { sortParams: __spreadArray(__spreadArray([], __read(prevSortParams), false), [sortParam], false) }));\r\n        this.render();\r\n    };\r\n    PivotSheet.prototype.handleGroupSort = function (event, meta) {\r\n        var _this = this;\r\n        event.stopPropagation();\r\n        this.interaction.addIntercepts([InterceptType.HOVER]);\r\n        var operator = {\r\n            onClick: function (_a) {\r\n                var key = _a.key;\r\n                _this.groupSortByMethod(key, meta);\r\n                // 排序事件完成触发\r\n                _this.emit(S2Event.RANGE_SORTED, event);\r\n            },\r\n            menus: TOOLTIP_OPERATOR_SORT_MENUS,\r\n        };\r\n        this.showTooltipWithInfo(event, [], {\r\n            operator: operator,\r\n            onlyMenu: true,\r\n        });\r\n    };\r\n    return PivotSheet;\r\n}(SpreadSheet));\r\nexport { PivotSheet };\r\n//# sourceMappingURL=pivot-sheet.js.map","references":["F:/Ismart/S2-master/node_modules/@antv/g-canvas/lib/index.d.ts","F:/Ismart/S2-master/node_modules/@types/lodash/index.d.ts","F:/Ismart/S2-master/packages/s2-core/src/sheet-type/spread-sheet.ts","F:/Ismart/S2-master/packages/s2-core/src/facet/layout/node.ts","F:/Ismart/S2-master/packages/s2-core/src/cell/index.ts","F:/Ismart/S2-master/packages/s2-core/src/common/constant/index.ts","F:/Ismart/S2-master/packages/s2-core/src/common/interface/index.ts","F:/Ismart/S2-master/packages/s2-core/src/common/interface/emitter.ts","F:/Ismart/S2-master/packages/s2-core/src/data-set/index.ts","F:/Ismart/S2-master/packages/s2-core/src/data-set/custom-tree-pivot-data-set.ts","F:/Ismart/S2-master/packages/s2-core/src/facet/index.ts"],"map":"{\"version\":3,\"file\":\"pivot-sheet.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../src/sheet-type/pivot-sheet.ts\"],\"names\":[],\"mappings\":\";AACA,OAAO,EAAE,KAAK,EAAE,IAAI,EAAE,MAAM,QAAQ,CAAC;AACrC,OAAO,EAAE,WAAW,EAAE,MAAM,gBAAgB,CAAC;AAE7C,OAAO,EAAE,QAAQ,EAAE,gBAAe;AAClC,OAAO,EACL,WAAW,EACX,aAAa,EACb,OAAO,EACP,2BAA2B,GAC5B,2BAA0B;AAU3B,OAAO,EAAE,YAAY,EAAE,oBAAmB;AAC1C,OAAO,EAAE,sBAAsB,EAAE,+CAA8C;AAC/E,OAAO,EAAE,UAAU,EAAE,iBAAgB;AAErC;IAAgC,8BAAW;IAA3C;;IA4LA,CAAC;IA3LQ,+BAAU,GAAjB,UAAkB,OAAkB;QAC1B,IAAA,OAAO,GAAoB,OAAO,QAA3B,EAAE,aAAa,GAAK,OAAO,cAAZ,CAAa;QAC3C,IAAI,OAAO,EAAE;YACX,OAAO,OAAO,CAAC,IAAI,CAAC,CAAC;SACtB;QACD,IAAM,WAAW,GACf,aAAa,KAAK,YAAY;YAC5B,CAAC,CAAC,IAAI,sBAAsB,CAAC,IAAI,CAAC;YAClC,CAAC,CAAC,IAAI,YAAY,CAAC,IAAI,CAAC,CAAC;QAC7B,OAAO,WAAW,CAAC;IACrB,CAAC;IAED;;OAEG;IACI,gCAAW,GAAlB;QACE,OAAO,IAAI,CAAC;IACd,CAAC;IAED;;OAEG;IACI,gCAAW,GAAlB;QACE,OAAO,KAAK,CAAC;IACf,CAAC;IAED;;OAEG;IACI,wCAAmB,GAA1B;QACE,IAAM,IAAI,GAAG,IAAI,CAAC,OAAO,CAAC,aAAa,CAAC;QACxC,0BAA0B;QAC1B,OAAO,IAAI,KAAK,MAAM,IAAI,IAAI,KAAK,YAAY,CAAC;IAClD,CAAC;IAED;;;OAGG;IACI,8CAAyB,GAAhC;QACE,OAAO,CAAC,IAAI,CAAC,iBAAiB,EAAE,CAAC;IACnC,CAAC;IAED;;OAEG;IACI,sCAAiB,GAAxB;;QACE,OAAO,MAAA,IAAI,CAAC,OAAO,0CAAE,eAAe,CAAC;IACvC,CAAC;IAED;;OAEG;IACI,kCAAa,GAApB;QACE,OAAO,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,WAAW,CAAC;IACzC,CAAC;IAEM,uCAAkB,GAAzB,UAA0B,SAAkB,EAAE,aAAuB;QACnE,IAAI,IAAI,CAAC,OAAO,YAAY,YAAY,EAAE;YACxC,IAAI,CAAC,OAAO,CAAC,kBAAkB,CAAC,SAAS,CAAC,CAAC;YAC3C,IAAI,CAAC,aAAa,EAAE;gBAClB,SAAS;gBACT,IAAI,CAAC,WAAW,CAAC,KAAK,EAAE,CAAC;gBACzB,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;aACpB;SACF;IACH,CAAC;IAES,qDAAgC,GAA1C;QAAA,iBAeC;QAdO,IAAA,KAAmB,IAAI,CAAC,OAAO,EAA7B,MAAM,YAAA,EAAE,IAAI,UAAiB,CAAC;QAChC,IAAA,KAAsB,IAAI,CAAC,OAAO,EAAhC,KAAK,WAAA,EAAE,QAAQ,cAAiB,CAAC;QACzC,UAAU;QACV,IAAM,WAAW,GAAG,UAAC,KAAe,IAAK,OAAA,IAAI,QAAQ,CAAC,KAAK,EAAE,KAAI,CAAC,EAAzB,CAAyB,CAAC;QAEnE,+CACK,MAAM,GACN,KAAK,GACL,IAAI,CAAC,OAAO,KACf,IAAI,MAAA,EACJ,WAAW,EAAE,IAAI,EACjB,OAAO,EAAE,IAAI,CAAC,OAAO,EACrB,QAAQ,EAAE,QAAQ,aAAR,QAAQ,cAAR,QAAQ,GAAI,WAAW,IACjC;IACJ,CAAC;IAES,+BAAU,GAApB;;QACE,IAAM,QAAQ,GAAG,IAAI,CAAC,gCAAgC,EAAE,CAAC;QACzD,MAAA,IAAI,CAAC,KAAK,0CAAE,OAAO,EAAE,CAAC;QACtB,IAAI,CAAC,KAAK,GAAG,IAAI,UAAU,CAAC,QAAQ,CAAC,CAAC;QACtC,IAAI,CAAC,KAAK,CAAC,MAAM,EAAE,CAAC;IACtB,CAAC;IAES,+BAAU,GAApB;QACE,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,2BAA2B,CAAC,CAAC;QAC9C,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,6BAA6B,CAAC,CAAC;QAChD,IAAI,CAAC,EAAE,CACL,OAAO,CAAC,2BAA2B,EACnC,IAAI,CAAC,6BAA6B,CACnC,CAAC;QACF,UAAU;QACV,IAAI,CAAC,EAAE,CACL,OAAO,CAAC,6BAA6B,EACrC,IAAI,CAAC,yBAAyB,CAC/B,CAAC;IACJ,CAAC;IAES,kDAA6B,GAAvC,UAAwC,IAAiC;;QAC/D,IAAA,EAAE,GAAkB,IAAI,GAAtB,EAAE,WAAW,GAAK,IAAI,YAAT,CAAU;QACjC,IAAM,OAAO,GAAuB;YAClC,KAAK,EAAE;gBACL,aAAa;oBACX,GAAC,EAAE,IAAG,WAAW;uBAClB;aACF;SACF,CAAC;QACF,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,oBAAoB,EAAE;YACtC,aAAa,EAAE,OAAO,CAAC,KAAK,CAAC,aAAa;YAC1C,IAAI,EAAE,IAAI,aAAJ,IAAI,uBAAJ,IAAI,CAAE,IAAI;SACjB,CAAC,CAAC;QAEH,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,CAAC;QACzB,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;QACnB,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,0BAA0B,EAAE;YAC5C,aAAa,EAAE,OAAO,CAAC,KAAK,CAAC,aAAa;YAC1C,IAAI,EAAE,IAAI,aAAJ,IAAI,uBAAJ,IAAI,CAAE,IAAI;SACjB,CAAC,CAAC;IACL,CAAC;IAES,8CAAyB,GAAnC,UAAoC,WAAoB;QACtD,IAAM,OAAO,GAAuB;YAClC,iBAAiB,EAAE,CAAC,WAAW;YAC/B,KAAK,EAAE;gBACL,aAAa,EAAE,IAAI;aACpB;SACF,CAAC;QACF,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,CAAC;QACzB,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;IACrB,CAAC;IAEM,sCAAiB,GAAxB,UAAyB,UAAsB,EAAE,IAAU;QACnD,IAAA,KAAoB,IAAI,CAAC,OAAO,CAAC,MAAM,EAArC,IAAI,UAAA,EAAE,OAAO,aAAwB,CAAC;QAC9C,IAAM,mBAAmB,GAAG,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,MAAM,CAAC,iBAAiB,CAAC;QACxE,IAAM,WAAW,GAAG,IAAI,CAAC,aAAa,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QAC9D,IAAA,KAAK,GAAY,IAAI,MAAhB,EAAE,KAAK,GAAK,IAAI,MAAT,CAAU;QAC9B,IAAM,SAAS,GAAG,KAAK,CAAC,KAAK,CAAC,CAAC;QAC/B,IAAI,SAAS,GAAG,KAAK,CAAC;QACtB,mEAAmE;QACnE,IAAI,mBAAmB,IAAI,IAAI,CAAC,aAAa,EAAE,EAAE;YAC/C,SAAS,GAAG,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;YAC1C,SAAS,CAAC,WAAW,CAAC,GAAG,SAAS,CAAC;SACpC;QAED,IAAM,SAAS,GAAc;YAC3B,WAAW,aAAA;YACX,UAAU,YAAA;YACV,aAAa,EAAE,SAAS;YACxB,KAAK,EAAE,SAAS;SACjB,CAAC;QACF,IAAM,cAAc,GAAG,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,MAAM,CACnD,UAAC,IAAI,IAAK,OAAA,CAAA,IAAI,aAAJ,IAAI,uBAAJ,IAAI,CAAE,WAAW,MAAK,WAAW,EAAjC,CAAiC,CAC5C,CAAC;QACF,SAAS;QACT,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,UAAU,yCAAM,cAAc,YAAE,SAAS,UAAE,CAAC;QAC9D,IAAI,CAAC,UAAU,uBACV,IAAI,CAAC,OAAO,KACf,UAAU,yCAAM,cAAc,YAAE,SAAS,aACzC,CAAC;QACH,IAAI,CAAC,MAAM,EAAE,CAAC;IAChB,CAAC;IAEM,oCAAe,GAAtB,UAAuB,KAAkB,EAAE,IAAU;QAArD,iBAgBC;QAfC,KAAK,CAAC,eAAe,EAAE,CAAC;QACxB,IAAI,CAAC,WAAW,CAAC,aAAa,CAAC,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC,CAAC;QACtD,IAAM,QAAQ,GAA2B;YACvC,OAAO,EAAE,UAAC,EAAO;oBAAL,GAAG,SAAA;gBACb,KAAI,CAAC,iBAAiB,CAAC,GAA4B,EAAE,IAAI,CAAC,CAAC;gBAC3D,WAAW;gBACX,KAAI,CAAC,IAAI,CAAC,OAAO,CAAC,YAAY,EAAE,KAAK,CAAC,CAAC;YACzC,CAAC;YACD,KAAK,EAAE,2BAA2B;SACnC,CAAC;QAEF,IAAI,CAAC,mBAAmB,CAAC,KAAK,EAAE,EAAE,EAAE;YAClC,QAAQ,UAAA;YACR,QAAQ,EAAE,IAAI;SACf,CAAC,CAAC;IACL,CAAC;IACH,iBAAC;AAAD,CAAC,AA5LD,CAAgC,WAAW,GA4L1C\"}","dts":{"name":"F:/Ismart/S2-master/packages/s2-core/node_modules/.cache/rollup-plugin-typescript2/placeholder/sheet-type/pivot-sheet.d.ts","writeByteOrderMark":false,"text":"import { Event as CanvasEvent } from '@antv/g-canvas';\r\nimport { SpreadSheet } from './spread-sheet';\r\nimport { Node } from \"../facet/layout/node\";\r\nimport { S2Options, SortMethod, SpreadSheetFacetCfg } from \"../common/interface\";\r\nimport { RowCellCollapseTreeRowsType } from \"../common/interface/emitter\";\r\nexport declare class PivotSheet extends SpreadSheet {\r\n    getDataSet(options: S2Options): any;\r\n    /**\r\n     * Check if is pivot mode\r\n     */\r\n    isPivotMode(): boolean;\r\n    /**\r\n     * Check if is pivot mode\r\n     */\r\n    isTableMode(): boolean;\r\n    /**\r\n     * tree type must be in strategy mode\r\n     */\r\n    isHierarchyTreeType(): boolean;\r\n    /**\r\n     * Check whether scroll contains row header\r\n     * For now contains row header in ListSheet mode by default\r\n     */\r\n    isScrollContainsRowHeader(): boolean;\r\n    /**\r\n     * Scroll Freeze Row Header\r\n     */\r\n    isFrozenRowHeader(): boolean;\r\n    /**\r\n     * Check if the value is in the columns\r\n     */\r\n    isValueInCols(): boolean;\r\n    clearDrillDownData(rowNodeId?: string, preventRender?: boolean): void;\r\n    protected getFacetCfgFromDataSetAndOptions(): SpreadSheetFacetCfg;\r\n    protected buildFacet(): void;\r\n    protected bindEvents(): void;\r\n    protected handleRowCellCollapseTreeRows(data: RowCellCollapseTreeRowsType): void;\r\n    protected handleTreeRowsCollapseAll(isCollapsed: boolean): void;\r\n    groupSortByMethod(sortMethod: SortMethod, meta: Node): void;\r\n    handleGroupSort(event: CanvasEvent, meta: Node): void;\r\n}\r\n"}}
