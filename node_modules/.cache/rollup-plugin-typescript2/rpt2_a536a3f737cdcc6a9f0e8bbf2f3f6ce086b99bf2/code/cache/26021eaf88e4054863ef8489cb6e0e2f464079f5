{"code":"import { __read, __spreadArray, __values } from \"tslib\";\r\nimport { isEmpty, isUndefined, uniqWith } from 'lodash';\r\nimport { TotalMeasure } from \"./total-measure\";\r\nimport { layoutArrange } from \"./layout-hooks\";\r\nimport { getDimsCondition } from \"../../utils/layout/get-dims-condition-by-node\";\r\nimport { addTotals } from \"../../utils/layout/add-totals\";\r\nimport { generateHeaderNodes } from \"../../utils/layout/generate-header-nodes\";\r\nimport { EXTRA_FIELD } from \"../../common/constant\";\r\nvar hideMeasureColumn = function (fieldValues, field, cfg) {\r\n    var e_1, _a;\r\n    var _b, _c;\r\n    var hideMeasure = (_c = (_b = cfg.colCfg) === null || _b === void 0 ? void 0 : _b.hideMeasureColumn) !== null && _c !== void 0 ? _c : false;\r\n    var valueInCol = cfg.dataSet.fields.valueInCols;\r\n    try {\r\n        for (var fieldValues_1 = __values(fieldValues), fieldValues_1_1 = fieldValues_1.next(); !fieldValues_1_1.done; fieldValues_1_1 = fieldValues_1.next()) {\r\n            var value = fieldValues_1_1.value;\r\n            if (hideMeasure && valueInCol && field === EXTRA_FIELD) {\r\n                fieldValues.splice(fieldValues.indexOf(value), 1);\r\n            }\r\n        }\r\n    }\r\n    catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n    finally {\r\n        try {\r\n            if (fieldValues_1_1 && !fieldValues_1_1.done && (_a = fieldValues_1.return)) _a.call(fieldValues_1);\r\n        }\r\n        finally { if (e_1) throw e_1.error; }\r\n    }\r\n};\r\n/**\r\n * Build grid hierarchy in rows or columns\r\n *\r\n * @param params\r\n */\r\nexport var buildGridHierarchy = function (params) {\r\n    var _a;\r\n    var addTotalMeasureInTotal = params.addTotalMeasureInTotal, addMeasureInTotalQuery = params.addMeasureInTotalQuery, parentNode = params.parentNode, currentField = params.currentField, fields = params.fields, facetCfg = params.facetCfg, hierarchy = params.hierarchy;\r\n    var index = fields.indexOf(currentField);\r\n    var dataSet = facetCfg.dataSet, values = facetCfg.values, spreadsheet = facetCfg.spreadsheet;\r\n    var fieldValues = [];\r\n    var query = {};\r\n    if (parentNode.isTotals) {\r\n        // add total measures\r\n        if (addTotalMeasureInTotal) {\r\n            query = getDimsCondition(parentNode.parent, true);\r\n            // add total measures\r\n            fieldValues.push.apply(fieldValues, __spreadArray([], __read(values.map(function (v) { return new TotalMeasure(v); })), false));\r\n        }\r\n    }\r\n    else {\r\n        // field(dimension)'s all values\r\n        query = getDimsCondition(parentNode, true);\r\n        var dimValues = dataSet.getDimensionValues(currentField, query);\r\n        var arrangedValues = layoutArrange(dimValues, facetCfg, parentNode, currentField);\r\n        fieldValues.push.apply(fieldValues, __spreadArray([], __read((arrangedValues || [])), false));\r\n        // add skeleton for empty data\r\n        var fieldName = dataSet.getFieldName(currentField);\r\n        if (isEmpty(fieldValues)) {\r\n            if (currentField === EXTRA_FIELD) {\r\n                fieldValues.push.apply(fieldValues, __spreadArray([], __read((_a = dataSet.fields) === null || _a === void 0 ? void 0 : _a.values), false));\r\n            }\r\n            else {\r\n                fieldValues.push(fieldName);\r\n            }\r\n        }\r\n        // hide measure in columns\r\n        hideMeasureColumn(fieldValues, currentField, facetCfg);\r\n        // add totals if needed\r\n        addTotals({\r\n            currentField: currentField,\r\n            lastField: fields[index - 1],\r\n            isFirstField: index === 0,\r\n            fieldValues: fieldValues,\r\n            spreadsheet: spreadsheet,\r\n        });\r\n    }\r\n    var hiddenColumnsDetail = spreadsheet.store.get('hiddenColumnsDetail');\r\n    var isEqualValueLeafNode = uniqWith(spreadsheet.getColumnLeafNodes(), function (prev, next) {\r\n        return prev.value === next.value;\r\n    }).length === 1;\r\n    var displayFieldValues = fieldValues.filter(function (value) {\r\n        // 去除多余的节点\r\n        if (isUndefined(value)) {\r\n            return false;\r\n        }\r\n        if (isEmpty(hiddenColumnsDetail)) {\r\n            return true;\r\n        }\r\n        return hiddenColumnsDetail.every(function (detail) {\r\n            return detail.hideColumnNodes.every(function (node) {\r\n                // 有数值字段 (hideMeasureColumn: true) 隐藏父节点\r\n                // 多列头场景(数值挂列头, 为隐藏数值列头, 自定义目录多指标等) 叶子节点是数值, 叶子节点的文本内容都一样, 需要额外比较父级节点的id是否相同, 确定到底渲染哪一列\r\n                var isMeasureField = node.field === EXTRA_FIELD;\r\n                if (isMeasureField || isEqualValueLeafNode) {\r\n                    return (node.parent.id !== parentNode.id && node.parent.value !== value);\r\n                }\r\n                // 没有数值字段 (hideMeasureColumn: false) 隐藏自己即可\r\n                return node.value !== value;\r\n            });\r\n        });\r\n    });\r\n    generateHeaderNodes({\r\n        currentField: currentField,\r\n        fields: fields,\r\n        fieldValues: displayFieldValues,\r\n        facetCfg: facetCfg,\r\n        hierarchy: hierarchy,\r\n        parentNode: parentNode,\r\n        level: index,\r\n        query: query,\r\n        addMeasureInTotalQuery: addMeasureInTotalQuery,\r\n        addTotalMeasureInTotal: addTotalMeasureInTotal,\r\n    });\r\n};\r\n//# sourceMappingURL=build-gird-hierarchy.js.map","references":["F:/Ismart/S2-master/node_modules/@types/lodash/index.d.ts","F:/Ismart/S2-master/packages/s2-core/src/facet/layout/interface.ts","F:/Ismart/S2-master/packages/s2-core/src/facet/layout/total-measure.ts","F:/Ismart/S2-master/packages/s2-core/src/facet/layout/layout-hooks.ts","F:/Ismart/S2-master/packages/s2-core/src/utils/layout/get-dims-condition-by-node.ts","F:/Ismart/S2-master/packages/s2-core/src/utils/layout/add-totals.ts","F:/Ismart/S2-master/packages/s2-core/src/utils/layout/generate-header-nodes.ts","F:/Ismart/S2-master/packages/s2-core/src/common/constant/index.ts","F:/Ismart/S2-master/packages/s2-core/src/common/interface/index.ts"],"map":"{\"version\":3,\"file\":\"build-gird-hierarchy.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../src/facet/layout/build-gird-hierarchy.ts\"],\"names\":[],\"mappings\":\"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\"}","dts":{"name":"F:/Ismart/S2-master/packages/s2-core/node_modules/.cache/rollup-plugin-typescript2/placeholder/facet/layout/build-gird-hierarchy.d.ts","writeByteOrderMark":false,"text":"import { GridHeaderParams } from \"./interface\";\r\n/**\r\n * Build grid hierarchy in rows or columns\r\n *\r\n * @param params\r\n */\r\nexport declare const buildGridHierarchy: (params: GridHeaderParams) => void;\r\n"}}
